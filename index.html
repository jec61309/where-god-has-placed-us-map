<!DOCTYPE html>
<html>
<head>
  <title>Where God Has Placed Us</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
const SHEET_ID = "1JnsbsIui3DZrxczAANMYyp3qun05kR-98ZmHZIC-ECE";
const API_KEY  = "AIzaSyC86YnNhyUyQtgOJX7PC0uQ5SUQGdUv7qs";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

let map;
let geocoder;
let markers = [];
let geocodeCache = new Map(); // address -> {lat,lng}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 42.06, lng: -82.63 },
    zoom: 12
  });
  geocoder = new google.maps.Geocoder();
  loadData();
}

// Remove old markers so refresh doesn't duplicate pins
function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

function pinColor(category) {
  if (category === "Work/School") return "green";
  if (category === "Play") return "orange";
  return "blue"; // Live (default)
}

function addMarker(lat, lng, category, title) {
  const marker = new google.maps.Marker({
    map,
    position: { lat, lng },
    title: title || "",
    icon: `https://maps.google.com/mapfiles/ms/icons/${pinColor(category)}-dot.png`
  });
  markers.push(marker);
}

function loadData() {
  fetch(SHEET_URL)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const rows = json.table.rows;

      clearMarkers();

      rows.forEach(row => {
        const cells = row.c;

        // Your columns:
        // 0 Timestamp
        // 1 Name
        // 2 Which best describes this location?
        // 3 Address or place name
        // 4 Latitude
        // 5 Longitude
        // 6 Approved (ignored now)

        const name     = cells[1]?.v || "";
        const category = cells[2]?.v || "";
        const address  = cells[3]?.v || "";
        const latRaw   = cells[4]?.v;
        const lngRaw   = cells[5]?.v;

        // No category = don't show (prevents accidental blanks from appearing)
        if (!category) return;

        const title = name ? `${name} (${category})` : category;

        // If we already have coordinates, use them
        if (typeof latRaw === "number" && typeof lngRaw === "number") {
          addMarker(latRaw, lngRaw, category, title);
          return;
        }

        // Otherwise, geocode the address
        const addr = (address || "").trim();
        if (!addr) return;

        // Cache to avoid re-geocoding the same address every refresh
        if (geocodeCache.has(addr)) {
          const cached = geocodeCache.get(addr);
          addMarker(cached.lat, cached.lng, category, title);
          return;
        }

        geocoder.geocode({ address: addr }, (results, status) => {
          if (status === "OK" && results && results[0]) {
            const loc = results[0].geometry.location;
            const lat = loc.lat();
            const lng = loc.lng();
            geocodeCache.set(addr, { lat, lng });
            addMarker(lat, lng, category, title);
          } else {
            // If an address can't be found, it simply won't place a pin.
            // (Often fixed by making the address more specific.)
            console.warn("Geocode failed:", addr, status);
          }
        });
      });
    })
    .catch(err => console.error("Sheet fetch error:", err));
}

// Refresh every 2 minutes
setInterval(loadData, 120000);
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC86YnNhyUyQtgOJX7PC0uQ5SUQGdUv7qs&callback=initMap">
</script>

</body>
</html>
